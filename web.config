<configuration>
  <system.webServer>
    <handlers>
      <!--
        Tells IIS to pass all requests to the iisnode module.
        The path should point to the Next.js server entry point.
      -->
      <add name="iisnode" path="node_modules/next/dist/bin/next-server.js" verb="*" modules="iisnode" />
    </handlers>

    <rewrite>
      <rules>
        <!-- Rule 1: Do not interfere with Next.js's internal requests -->
        <rule name="next-internals" stopProcessing="true">
          <match url="^(\_next\/.*)" />
          <action type="None" />
        </rule>

        <!-- Rule 2: Route all other requests to the iisnode handler (your Next.js app) -->
        <rule name="next-server">
          <match url="/*" />
          <action type="Rewrite" url="node_modules/next/dist/bin/next-server.js" />
        </rule>
      </rules>
    </rewrite>

    <!--
      You may need to increase this value for server-side rendering or API routes
      that have long processing times.
    -->
    <httpErrors errorMode="Detailed" />
    <asp scriptErrorSentToBrowser="true" />
  </system.webServer>

  <!--
    Increase the stdout log size for iisnode if you need more detailed logs
    for debugging. The logs are typically created in a folder named 'iisnode'
    in your site's root directory.
  -->
  <system.web>
    <compilation batch="false" />
  </system.web>
</configuration>
